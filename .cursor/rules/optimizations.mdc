---
description: Performance optimization guidelines for Albucore
globs:
alwaysApply: false
---

**IMPORTANT**: For complete performance guidelines, see [docs/performance-optimization.md](../../docs/performance-optimization.md).

## Quick Reference: OpenCV LUT Operations

### Critical: Maintain float32 dtype for LUT arrays

When using `cv2.LUT()` with floating-point lookup tables, **always ensure the LUT array is float32, not float64**.

#### The Problem

OpenCV's statistics functions (`cv2.meanStdDev`, etc.) return float64 values. When these are used in LUT creation:

```python
# BAD: Creates float64 LUT due to numpy promotion
mean, std = cv2.meanStdDev(img)  # Returns float64
lut = (np.arange(0, 256, dtype=np.float32) - mean[0, 0]) / std[0, 0]
# lut.dtype is now float64!
```

#### The Solution

Cast the LUT array to float32 after creation:

```python
# GOOD: Maintain float32 throughout
lut = ((np.arange(0, 256, dtype=np.float32) - mean[0, 0]) / std[0, 0]).astype(np.float32)
# lut.dtype is float32
```

#### Performance Impact

For a video of shape (200, 256, 256, 3):
- With float64 LUT: ~111ms (includes expensive astype on result)
- With float32 LUT: ~55ms (2x faster!)

#### Best Practices

1. **For uint8 images**: LUT operations are extremely fast and should be preferred when possible
2. **Always check dtype**: Use `.astype(np.float32)` on small LUT arrays (256 elements) rather than large result arrays
3. **Avoid dtype promotion**: Be aware that numpy operations with mixed dtypes promote to the higher precision type

For complete guidelines, see [docs/performance-optimization.md](../../docs/performance-optimization.md).
